.. _env:

Update the ``.env`` file
#############################

.. _gather-info-env:

Gather required values
======================

Fetch the values needed to update the environment variables.

.. _fetch-hostname-env:

#. In a Windows CMD or PowerShell terminal, fetch the hostname of the VM :

   .. tabs::

      .. code-tab:: pwsh
         :caption: CMD or PowerShell

         hostname


#. In PowerShell, fetch the domain suffix of the VM:

   .. tabs::

      .. code-tab:: pwsh
         :caption: PowerShell

            Get-DnsClientGlobalSetting

   The ``SuffixSearchList`` is displayed in the output.

   .. code-block::
    :caption: .env

    SuffixSearchList    : {win.ansys.com, ansys.com}

#. From ``SuffixSearchList``, note down the first value as ``<domain_suffix>`` and the second value as ``<domain_short_suffix>``.

   .. image:: /_static/documenting/domain_name.png
      :width: 50%

   .. note::
      Subsequent steps use the following placeholders:

      * ``<hostname>`` is the hostname of the machine.
      * ``<domain_suffix>`` is the full domain suffix.
      * ``<domain_short_suffix>`` is the short domain suffix.

#. Verify WSL Ubuntu Linux distribution installed in the host machine.

   .. tabs::

      .. code-tab:: pwsh
         :caption: CMD

         wsl --list

   .. note::
      The output lists the installed Linux distributions.

   .. attention::
      Ubuntu 20.04 is the only official supported version, so preferably this should be the default Ubuntu installation. 
      The following WSL command sets the default Linux distribution where **<ubuntu_distro_name>** is the name of the Ubuntu distribution installed in WSL.

      .. tabs::

         .. code-tab:: pwsh
            :caption: CMD

            wsl --set-default <ubuntu_distro_name>

   .. note::
      The ``<ubuntu_distro_name>`` is the name of the Ubuntu distribution installed in WSL.

.. _edit-variables-env:

Edit environment variables
===========================

#. Open the ``.env`` file at the root of the ``Ansys_App_Portal_and_Deployment_Template`` directory.


#. Update and check the following configuration variables:

   * Verify ``PIM_PORT`` variable:

     .. code-block::
      :caption: .env (default to 8443)

      PIM_PORT=8443

   * Verify ``OSL_VERSION`` variable:

     .. code-block::
      :caption: .env (default to 242)

      OSL_VERSION=242

   * Update ``SOLUTIONS_DIRECTORY_PATH`` variable:

     .. code-block::
      :caption: .env

      SOLUTIONS_DIRECTORY_PATH=<directory where *awa solution files are deployed>

   * Verify/update ``WSL_LINUX_DISTRO`` variable:

     .. code-block::
      :caption: .env (default to Ubuntu-20.04)

      WSL_LINUX_DISTRO=Ubuntu-20.04


#. Set the ``MACHINE_HOSTNAME`` variable:

   .. code-block::
    :caption: .env

    MACHINE_HOSTNAME=<hostname>.<domain_suffix>


#. Update the following **Keycloak** variables:

   * Update ``KC_DOMAIN`` by suffixing with the value of ``MACHINE_HOSTNAME``:

     .. code-block::
      :caption: .env

      KC_DOMAIN=keycloak.<MACHINE_HOSTNAME>

   * Update ``KC_PORT``:

     .. code-block::
      :caption: .env

      KC_PORT=8012

#. Update the following **Traefik** variables:

   * Update ``TR_PORT``:

     .. code-block::
      :caption: .env

      TR_PORT=8011

   * Add ``TR_HOST_URL``:

     .. code-block::
      :caption: .env

      TR_HOST_URL=traefik.<hostname>.<domain_suffix>

#. Update the following **OAuth2 Proxy** variables:

   * Update ``OP_BASE_URL``:

     .. code-block::
      :caption: .env

      OP_BASE_URL=oauth.<hostname>.<domain_suffix>

   * Update ``OP_COOKIE_DOMAIN``:

     .. code-block::
      :caption: .env

      OP_COOKIE_DOMAIN=.<hostname>.<domain_suffix>

   * Update ``OP_WHITELIST_DOMAIN``:

     .. code-block::
      :caption: .env

      OP_WHITELIST_DOMAIN=.<hostname>.<domain_suffix>:*

   * Update ``OP_REDIRECT_URL``:

     .. code-block::
      :caption: .env

      OP_REDIRECT_URL=http://${OP_BASE_URL}:${TR_PORT}/oauth2/callback

   * Update ``OP_SIGNOUT_URL``:

     .. code-block::
      :caption: .env

      OP_SIGNOUT_URL=http://${OP_BASE_URL}:${TR_PORT}/oauth2/sign_out

   * Add ``OP_HOST_URL``:

     .. code-block::
      :caption: .env

      OP_HOST_URL=oauth.<hostname>.<domain_suffix>

   * Add ``OP_BASE_DOMAIN``:

     .. code-block::
      :caption: .env

      OP_BASE_DOMAIN=<hostname>.<domain_suffix>

#. Update the ``PS_BASE_URL`` **portal server** variable:

   .. code-block::
    :caption: .env

    PS_BASE_URL=portal.<hostname>.<domain_suffix>

#. Update the following **portal UI** variables:

   * Update ``PU_BASE_URL``:

     .. code-block::
      :caption: .env

      PU_BASE_URL=portal.<hostname>.<domain_suffix>

   * Update ``PORTAL_API_URL``:

     .. code-block::
      :caption: .env

      PORTAL_API_URL=http://${PS_BASE_URL}:${TR_PORT}/api/v1/





